<ion-header [translucent]="true">
  <ion-toolbar class="header-toolbar">
    <ion-title class="header-title">
      <ion-icon name="settings-outline" class="title-icon"></ion-icon>
      Réglages
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="logout()" class="header-button">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="settings-content">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Chargement des paramètres...</p>
  </div>

  <div *ngIf="!isLoading" class="settings-container animate-fade-in">
    <!-- Stats Summary -->
    <div class="stats-summary">
      <div class="stat-item">
        <div
          class="stat-icon"
          [class.active]="config.enableNotifications"
          [class.inactive]="!config.enableNotifications"
        >
          <ion-icon name="notifications"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number"
            >{{ config.enableNotifications ? 'ON' : 'OFF' }}</span
          >
          <span class="stat-label">Alertes</span>
        </div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <div class="stat-icon gradient-success">
          <ion-icon name="calendar"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ config.notificationDays }}j</span>
          <span class="stat-label">Avant expiration</span>
        </div>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <div class="stat-icon gradient-warning">
          <ion-icon name="time"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ config.notificationHours.length }}</span>
          <span class="stat-label">Heures</span>
        </div>
      </div>
    </div>

    <!-- Notifications Section -->
    <div class="section-title animate-slide-in-right">
      <ion-icon name="notifications-outline"></ion-icon>
      Configuration des Notifications
    </div>

    <ion-card class="settings-card">
      <ion-card-content>
        <!-- Enable/Disable Notifications -->
        <div class="setting-item">
          <div class="setting-icon" [class.active]="config.enableNotifications">
            <ion-icon name="notifications"></ion-icon>
          </div>
          <div class="setting-content">
            <h3>Activer les notifications</h3>
            <p>Recevoir des alertes pour les documents expirés</p>
          </div>
          <ion-toggle
            [(ngModel)]="config.enableNotifications"
            (ionChange)="onNotificationToggle()"
            class="elegant-toggle"
          ></ion-toggle>
        </div>

        <!-- Days Before Expiration -->
        <div
          class="setting-item"
          [class.disabled]="!config.enableNotifications"
        >
          <div class="setting-icon gradient-success">
            <ion-icon name="calendar"></ion-icon>
          </div>
          <div class="setting-content">
            <h3>Jours avant expiration</h3>
            <p>Nombre de jours avant l'expiration pour être notifié</p>
          </div>
          <div class="setting-input">
            <ion-input
              [(ngModel)]="config.notificationDays"
              type="number"
              min="1"
              max="365"
              placeholder="30"
              [disabled]="!config.enableNotifications"
              (ionBlur)="onNotificationDaysChange()"
              class="number-input"
            ></ion-input>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Notification Hours Section -->
    <div
      class="section-title animate-slide-in-right"
      *ngIf="config.enableNotifications"
    >
      <ion-icon name="time-outline"></ion-icon>
      Heures de Notifications
    </div>

    <ion-card class="settings-card" *ngIf="config.enableNotifications">
      <ion-card-content>
        <p class="section-description">
          Sélectionnez les heures auxquelles vous souhaitez recevoir les
          notifications
        </p>

        <div class="chips-container">
          <ion-chip
            *ngFor="let hour of config.notificationHours; let i = index"
            class="time-chip"
            (click)="removeNotificationHour(i)"
          >
            <ion-icon name="time"></ion-icon>
            <ion-label>{{ formatHour(hour) }}</ion-label>
            <ion-icon name="close-circle" class="remove-icon"></ion-icon>
          </ion-chip>

          <ion-button
            class="add-chip-btn"
            fill="clear"
            size="small"
            (click)="showHourPicker()"
            [disabled]="config.notificationHours.length >= 6"
          >
            <ion-icon name="add-circle" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Hour Selector -->
        <div class="selector-wrapper" *ngIf="showHourSelector">
          <ion-select
            [(ngModel)]="selectedHour"
            placeholder="Choisir une heure"
            (ionChange)="addNotificationHour()"
            interface="action-sheet"
            class="elegant-select"
          >
            <ion-select-option
              *ngFor="let hour of availableHours"
              [value]="hour"
            >
              {{ formatHour(hour) }}
            </ion-select-option>
          </ion-select>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Notification Intervals Section -->
    <div
      class="section-title animate-slide-in-right"
      *ngIf="config.enableNotifications"
    >
      <ion-icon name="repeat-outline"></ion-icon>
      Intervalles de Rappel
    </div>

    <ion-card class="settings-card" *ngIf="config.enableNotifications">
      <ion-card-content>
        <p class="section-description">
          Jours avant expiration pour recevoir des rappels (ex: 7, 3, 1, 0)
        </p>

        <div class="chips-container">
          <ion-chip
            *ngFor="let interval of config.notificationIntervals; let i = index"
            class="interval-chip"
            (click)="removeNotificationInterval(i)"
          >
            <ion-icon name="calendar"></ion-icon>
            <ion-label
              >{{ interval === 0 ? 'Jour J' : interval + 'j avant' }}</ion-label
            >
            <ion-icon name="close-circle" class="remove-icon"></ion-icon>
          </ion-chip>

          <ion-button
            class="add-chip-btn"
            fill="clear"
            size="small"
            (click)="showIntervalPicker()"
            [disabled]="config.notificationIntervals.length >= 10"
          >
            <ion-icon name="add-circle" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- Interval Selector -->
        <div class="selector-wrapper" *ngIf="showIntervalSelector">
          <ion-input
            [(ngModel)]="selectedInterval"
            type="number"
            min="0"
            max="365"
            placeholder="Ex: 7 pour 7 jours avant"
            (ionBlur)="addNotificationInterval()"
            class="elegant-input"
          ></ion-input>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- General Configuration Section -->
    <div class="section-title animate-slide-in-right">
      <ion-icon name="cog-outline"></ion-icon>
      Configuration Générale
    </div>

    <ion-card class="settings-card">
      <ion-card-content>
        <!-- Test Notification -->
        <div class="action-item" (click)="testNotification()">
          <div class="action-icon gradient-info">
            <ion-icon name="notifications"></ion-icon>
          </div>
          <div class="action-content">
            <h3>Tester les notifications</h3>
            <p>Envoyer une notification de test dans 5 secondes</p>
          </div>
          <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
        </div>

        <!-- Check Current Hour Notifications -->
        <div class="action-item" (click)="checkCurrentHourNotifications()">
          <div class="action-icon gradient-success">
            <ion-icon name="time"></ion-icon>
          </div>
          <div class="action-content">
            <h3>Vérifier l'heure actuelle</h3>
            <p>Voir si l'heure actuelle déclenche des notifications</p>
          </div>
          <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
        </div>

        <!-- Reset to Defaults -->
        <div class="action-item" (click)="resetToDefaults()">
          <div class="action-icon gradient-danger">
            <ion-icon name="refresh"></ion-icon>
          </div>
          <div class="action-content">
            <h3>Réinitialiser aux valeurs par défaut</h3>
            <p>Remettre tous les paramètres à leur valeur d'origine</p>
          </div>
          <ion-icon name="chevron-forward" class="action-arrow"></ion-icon>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Summary Section -->
    <div class="section-title animate-slide-in-right">
      <ion-icon name="information-circle-outline"></ion-icon>
      Résumé
    </div>

    <ion-card class="summary-card">
      <ion-card-content>
        <div class="summary-grid">
          <div class="summary-item">
            <span class="summary-label">Notifications</span>
            <span
              class="summary-value"
              [class.active]="config.enableNotifications"
            >
              {{ config.enableNotifications ? 'Activées' : 'Désactivées' }}
            </span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Jours avant expiration</span>
            <span class="summary-value"
              >{{ config.notificationDays }} jours</span
            >
          </div>
          <div class="summary-item">
            <span class="summary-label">Heures</span>
            <span class="summary-value">{{ getNotificationHoursText() }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Intervalles</span>
            <span class="summary-value"
              >{{ getNotificationIntervalsText() }}</span
            >
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Save Button -->
    <div class="save-section">
      <ion-button
        class="save-button"
        expand="block"
        (click)="saveConfiguration()"
      >
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        Sauvegarder la Configuration
      </ion-button>
    </div>

    <!-- Logout Section -->
    <div class="logout-section">
      <ion-button
        class="logout-button"
        expand="block"
        color="danger"
        (click)="logout()"
      >
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        Déconnexion
      </ion-button>
    </div>
  </div>
</ion-content>
